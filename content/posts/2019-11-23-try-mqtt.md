---
title: try mqtt
date: 2019-11-23
---

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [MQTT Startup](#mqtt-startup)
- [MQTT & Kafka [To-do]](#mqtt--kafka-to-do)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## MQTT Startup

1. A brief intro on MQTT：[MQTT](https://github.com/mqtt/mqtt.github.io/wiki)

   Broker：

   | Server                                                       | QoS 0 | QoS 1 | QoS 2 | auth | [bridge](https://github.com/mqtt/mqtt.github.io/wiki/bridge_protocol) | [$SYS](https://github.com/mqtt/mqtt.github.io/wiki/conventions#%24sys) | SSL  | [dynamic topics](https://github.com/mqtt/mqtt.github.io/wiki/are_topics_dynamic) | cluster | websockets | plugin system |
   | ------------------------------------------------------------ | ----- | ----- | ----- | ---- | ------------------------------------------------------------ | ------------------------------------------------------------ | ---- | ------------------------------------------------------------ | ------- | ---------- | ------------- |
   | [2lemetry](http://2lemetry.com/platform/)                    | ✔     | ✔     | ✔     | ✔    | ✔                                                            | §                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✘             |
   | [Jmqtt](https://github.com/Cicizz/jmqtt)                     | ✔     | ✔     | ✔     | ✔    | ✔                                                            | §                                                            | §    | ✔                                                            | §       | ✔          | ✔             |
   | [Apache ActiveMQ](http://activemq.apache.org/)               | ✔     | ✔     | ✔     | ✔    | ✘                                                            | ✘                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✔             |
   | [Apache ActiveMQ Artemis](http://activemq.apache.org/artemis) | ✔     | ✔     | ✔     | ✔    | ✘                                                            | ✘                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✔             |
   | [Bevywise IoT Platform](https://www.bevywise.com/iot-platform/) | ✔     | ✔     | ✔     | ✔    | ✔                                                            | ✔                                                            | ✔    | ✔                                                            | ✔       | ✔          | **rm**        |
   | [emitter](https://github.com/emitter-io/emitter)             | ✔     | §     | ✘     | ✔    | ✘                                                            | ✘                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✘             |
   | [emqttd](http://emqtt.io/)                                   | ✔     | ✔     | ✔     | ✔    | ✔                                                            | ✔                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✔             |
   | [flespi](https://flespi.com/mqtt-broker)                     | ✔     | ✔     | ✔     | ✔    | ✘                                                            | ✘                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✘             |
   | [GnatMQ](https://github.com/ppatierno/gnatmq)                | ✔     | ✔     | ✔     | ✔    | ✘                                                            | ✘                                                            | ✘    | ✔                                                            | ✘       | ✘          | ✘             |
   | [HBMQTT](https://github.com/beerfactory/hbmqtt)              | ✔     | ✔     | ✔     | ✔    | ✘                                                            | ✔                                                            | ✔    | ✔                                                            | ✘       | ✔          | ✔             |
   | [HiveMQ](http://www.hivemq.com/)                             | ✔     | ✔     | ✔     | ✔    | ✔                                                            | ✔                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✔             |
   | [IBM WIoTP Message Gateway](https://developer.ibm.com/iotplatform/messagegateway/) | ✔     | ✔     | ✔     | ✔    | ✔                                                            | ✔                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✔             |
   | [moquette](https://github.com/andsel/moquette)               | ✔     | ✔     | ✔     | ✔    | ?                                                            | ?                                                            | ✔    | ?                                                            | **rm**  | ✔          | ✘             |
   | [JoramMQ](http://mqtt.jorammq.com/)                          | ✔     | ✔     | ✔     | ✔    | ✔                                                            | ✔                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✔             |
   | [Mongoose](https://github.com/cesanta/mongoose)              | ✔     | ✔     | ?     | ?    | ?                                                            | ?                                                            | ?    | ?                                                            | ?       | ?          | ?             |
   | [mosca](https://github.com/mqtt/mqtt.github.io/wiki/mosca)   | ✔     | ✔     | ✘     | ✔    | ?                                                            | ?                                                            | ?    | ?                                                            | ✘       | ✔          | ✘             |
   | [mosquitto](https://github.com/mqtt/mqtt.github.io/wiki/mosquitto_message_broker) | ✔     | ✔     | ✔     | ✔    | ✔                                                            | ✔                                                            | ✔    | ✔                                                            | §       | ✔          | ✔             |
   | [MQTT.js](https://github.com/mqttjs/MQTT.js)                 | ✔     | ✔     | ✔     | §    | ✘                                                            | ✘                                                            | ✔    | ✔                                                            | ✘       | ✔          | ✘             |
   | [MqttWk](https://github.com/Wizzercn/MqttWk)                 | ✔     | ✔     | ✔     | ✔    | ✔                                                            | ?                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✘             |
   | [RabbitMQ](http://www.rabbitmq.com/blog/2012/09/12/mqtt-adapter/) | ✔     | ✔     | ✘     | ✔    | ✘                                                            | ✘                                                            | ✔    | ✔                                                            | ?       | ?          | ?             |
   | [RSMB](https://github.com/mqtt/mqtt.github.io/wiki/Really-Small-Message-Broker) | ✔     | ✔     | ✔     | ✔    | ✔                                                            | ✔                                                            | ✘    | ✔                                                            | ✘       | ✘          | ?             |
   | [Software AG Universal Messaging](http://um.terracotta.org/#page/%2Fum.terracotta.org%2Funiversal-messaging-webhelp%2Fto-mqttoverview.html%23) | ✔     | ✔     | ✔     | ✔    | ✘                                                            | ✘                                                            | ✔    | ✔                                                            | ✔       | rm         | ✘             |
   | [Solace](http://dev.solacesystems.com/tech)                  | ✔     | ✔     | ✘     | ✔    | §                                                            | ✔                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✘             |
   | [SwiftMQ](http://www.swiftmq.com/landing/router/index.html)  | ✔     | ✔     | ✔     | ✔    | ✔                                                            | ✘                                                            | ✔    | ✔                                                            | ✔       | ✘          | ✔             |
   | [Trafero Tstack](https://github.com/trafero/tstack)          | ✔     | ✔     | ✔     | ✔    | ✘                                                            | ✘                                                            | ✔    | ✔                                                            | ✘       | ✘          | ✘             |
   | [VerneMQ](https://verne.mq/)                                 | ✔     | ✔     | ✔     | ✔    | ✔                                                            | ✔                                                            | ✔    | ✔                                                            | ✔       | ✔          | ✔             |
   | [WebSphere MQ](http://www-03.ibm.com/software/products/en/wmq/) | ✔     | ✔     | ✔     | ✔    | ✔                                                            | ✔                                                            | ✔    | ✔                                                            | ?       | ?          | ?             |

2. [MQTT Broker 选型](https://www.jianshu.com/p/cf91f4bea071)

3. [EMQ 开源版本和企业版本以及平台版本详细对比](https://www.emqx.io/static/files/EMQ_X_product_compare_cn.pdf)

纠结了一会，选择EMQX作为MQTT Broker 来搞一个demo。EMQX MQTT协议支持完善，支持集群，Apache License 2.0，文档全，开源社区相对活跃。

EMQX 官网文档：https://docs.emqx.io/broker/v3/cn/

EMQX Github：https://github.com/emqx/emqx

EMQX Docker Hub：https://hub.docker.com/r/emqx/emqx

EMQX文档相当完善，中文，建议完全阅读。

Targets:

1. 运行EMQX作为MQTT Broker

   容器部署：

   ```shell
   docker pull emqx/emqx:v3.2.5
   ```

   ```shell
   docker run -d --name emqx -p 1883:1883 -p 8083:8083 -p 8883:8883 -p 8084:8084 -p 18083:18083 emqx/emqx
   ```

   | 1883  | MQTT 协议端口            |
   | ----- | ------------------------ |
   | 8883  | MQTT/SSL 端口            |
   | 8083  | MQTT/WebSocket 端口      |
   | 8080  | HTTP API 端口            |
   | 18083 | Dashboard 管理控制台端口 |

2. 客户端使用spring-integration-mqtt作为mqtt客户端，

   依赖：

   ```xml
               <dependency>
                   <groupId>org.springframework.integration</groupId>
                   <artifactId>spring-integration-mqtt</artifactId>
                   <version>5.2.1.RELEASE</version>
               </dependency>
   ```

   Java Configuration:

   ```java
   @Configuration
   public class MqttConfiguration {
       @Bean
       public MqttPahoClientFactory mqttClientFactory() {
           DefaultMqttPahoClientFactory factory = new DefaultMqttPahoClientFactory();
           MqttConnectOptions options = new MqttConnectOptions();
           options.setServerURIs(new String[]{"tcp://localhost:1883"});
           factory.setConnectionOptions(options);
           return factory;
       }
   
       @Bean
       public MessageChannel mqttInputChannel() {
           return new DirectChannel();
       }
   
       @Bean
       public MessageProducer inbound() {
           MqttPahoMessageDrivenChannelAdapter adapter = new MqttPahoMessageDrivenChannelAdapter("mqttSubscriber",
                   mqttClientFactory(), "mqtt-test");
           adapter.setCompletionTimeout(5000);
           adapter.setConverter(new DefaultPahoMessageConverter());
           adapter.setQos(1);
           adapter.setOutputChannel(mqttInputChannel());
           return adapter;
       }
   
       @Bean
       @ServiceActivator(inputChannel = "mqttInputChannel")
       public MessageHandler handler() {
           return message -> {
               String payload = message.getPayload().toString();
               String topic = message.getHeaders().get(MqttHeaders.RECEIVED_TOPIC).toString();
               System.out.println("收到来自" + topic + "的消息：" + payload);
           };
       }
   
       @Bean
       public MessageChannel mqttOutboundChannel() {
           return new DirectChannel();
       }
   
       @Bean
       @ServiceActivator(inputChannel = "mqttOutboundChannel")
       public MessageHandler outbound() {
           // 在这里进行mqttOutboundChannel的相关设置
           MqttPahoMessageHandler messageHandler =
                   new MqttPahoMessageHandler("mqttPublisher", mqttClientFactory());
           messageHandler.setAsync(true); //如果设置成true，发送消息时将不会阻塞。
           messageHandler.setDefaultTopic("mqtt-test");
           return messageHandler;
       }
   }
   ```

   Mqtt Message Gateway：

   ```java
   @MessagingGateway(defaultRequestChannel = "mqttOutboundChannel")
   public interface MqttPublisher {
       void sendToMqtt(String payload);
       void sendToMqtt(@Header(MqttHeaders.TOPIC) String topic, String payload);
       void sendToMqtt(@Header(MqttHeaders.TOPIC) String topic, @Header(MqttHeaders.QOS) int qos, String payload);
   }
   ```

   来个LLT测试一下：

   ```java
   @RunWith(SpringRunner.class)
   @SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
   public class MqttTest {
       @Autowired
       private MqttPublisher mqttGateway;
   
       @Test
       public void init() {
           try {
               mqttGateway.sendToMqtt("mqtt-test", "this is a mqtt message from test");
               System.out.println("send mqtt message successfully.");
           } catch (Exception e) {
               System.out.println("send mqtt message failed.");
           }
       }
   }
   ```

   执行成功后，配置中定义的订阅消费者MessageHandler会收到消息，并打印：

   ```shell
   收到来自mqtt-test的消息：this is a mqtt message from test
   ```

## MQTT & Kafka [To-do]



