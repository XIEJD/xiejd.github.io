<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Shareif">
    <meta name="description" content="Tech Notes">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Kafkaæºç é˜…è¯»å°è®°ä¹‹æ¶ˆè´¹è€…æ¦‚è§ˆ"/>
<meta name="twitter:description" content="Spring Kafkaå¦‚ä½•åˆå§‹åŒ–@KafkaListeneræ ‡è®°çš„bean"/>

    <meta property="og:title" content="Spring Kafkaæºç é˜…è¯»å°è®°ä¹‹æ¶ˆè´¹è€…æ¦‚è§ˆ" />
<meta property="og:description" content="Spring Kafkaå¦‚ä½•åˆå§‹åŒ–@KafkaListeneræ ‡è®°çš„bean" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.shareif.cn/posts/spring-kafka/" />
<meta property="article:published_time" content="2020-02-12T22:27:08+08:00" />
<meta property="article:modified_time" content="2020-02-23T23:35:18+08:00" />


    
      <base href="https://www.shareif.cn/posts/spring-kafka/">
    
    <title>
  Spring Kafkaæºç é˜…è¯»å°è®°ä¹‹æ¶ˆè´¹è€…æ¦‚è§ˆ Â· Shareif
</title>

    
      <link rel="canonical" href="https://www.shareif.cn/posts/spring-kafka/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://www.shareif.cn/css/coder.min.d141d1c513ddaf5e322d1b1bb0d04c52c2f534803f99eb70a77e9bc95211cc0e.css" integrity="sha256-0UHRxRPdr14yLRsbsNBMUsL1NIA/metwp36byVIRzA4=" crossorigin="anonymous" media="screen" />
    

    

    

    

    

    

    <link rel="icon" type="image/png" href="https://www.shareif.cn/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://www.shareif.cn/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.63.2" />
  </head>

  
  
  <body class="colorscheme-light">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://www.shareif.cn/">
      Shareif
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://www.shareif.cn/posts/">æ–‡</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://www.shareif.cn/about/">_</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Spring Kafkaæºç é˜…è¯»å°è®°ä¹‹æ¶ˆè´¹è€…æ¦‚è§ˆ</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-02-12T22:27:08&#43;08:00'>
                Created 2020-02-12
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              5-minute read
            </span>
          </div>
          <div class="categories">
  <i class="fas fa-folder"></i>
    <a href="https://www.shareif.cn/categories/dive-in-framework/">DIVE-IN-FRAMEWORK</a></div>

          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="https://www.shareif.cn/tags/spring-kafka/">Spring Kafka</a>
      <span class="separator">â€¢</span>
    <a href="https://www.shareif.cn/tags/kafkalistener/">KafkaListener</a></div>

          <div class="date">
            <span class="posted-on">
              <i class="fas fa-edit"></i>
              <time datetime='2020-02-23T23:35:18&#43;08:00'>
                Modified 2020-02-23
              </time>
            </span>
          </div>
        </div>
      </header>

      <div>
        
        <!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<ul>
<li><a href="#1-%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89kafka%E6%B6%88%E8%B4%B9%E8%80%85">1. å¦‚ä½•å®šä¹‰kafkaæ¶ˆè´¹è€…</a></li>
<li><a href="#2-%E5%A4%9A%E5%AE%9E%E4%BE%8B%E9%83%A8%E7%BD%B2">2. å¤šå®ä¾‹éƒ¨ç½²</a></li>
<li><a href="#3-%E5%8A%A8%E6%80%81%E6%B6%88%E8%B4%B9%E8%80%85">3. åŠ¨æ€æ¶ˆè´¹è€…</a></li>
<li><a href="#4-ack%E6%A8%A1%E5%BC%8F%E4%B8%8E%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">4. Ackæ¨¡å¼ä¸é”™è¯¯å¤„ç†</a></li>
<li><a href="#5-dive-in-src">5. Dive In Src</a>
<ul>
<li><a href="#41-%E6%B3%A8%E8%A7%A3%E6%89%AB%E6%8F%8F">4.1 æ³¨è§£æ‰«æ</a></li>
<li><a href="#42-%E5%88%9D%E5%A7%8B%E5%8C%96">4.2 åˆå§‹åŒ–</a></li>
<li><a href="#43-%E8%BF%90%E8%A1%8C%E6%B6%88%E8%B4%B9%E8%80%85">4.3 è¿è¡Œæ¶ˆè´¹è€…</a></li>
</ul>
</li>
<li><a href="#6-%E6%80%BB%E7%BB%93">6. æ€»ç»“</a></li>
<li><a href="#7-%E6%9C%89%E6%84%9F">7. æœ‰æ„Ÿ</a></li>
<li><a href="#8-%E5%8F%82%E8%80%83">8. å‚è€ƒ</a></li>
</ul>
<!-- raw HTML omitted -->
<p>Spring Kafkaåœ¨åŸç”Ÿkafkaå®¢æˆ·ç«¯çš„åŸºç¡€ä¸Šè¿›è¡Œäº†å°è£…ï¼Œæä¾›äº†éå¸¸æ–¹ä¾¿çš„é…ç½®æ–¹æ³•å’Œä½¿ç”¨æ–¹æ³•ï¼Œä¸ç®¡æ˜¯ç”Ÿäº§è€…æˆ–æ˜¯æ¶ˆè´¹è€…ï¼Œéƒ½èƒ½ç®€å•å‡ è¡Œä»£ç æå®šã€‚éå¸¸çš„Springã€‚å‰å‡ å¤©é‡åˆ°åŒä¸€æ¶ˆè´¹è€…ç»„ä¸‹éœ€è¦å¤šå®ä¾‹é›†ç¾¤ä¸­ä»…å•å®ä¾‹æ¶ˆè´¹çš„éœ€æ±‚ï¼Œç”±äºåˆæ¬¡æ¥è§¦Spring Kafkaè¿™ä¸ªæ¡†æ¶ï¼Œä¸€æ—¶ä¹‹é—´æ²¡æƒ³åˆ°ä»€ä¹ˆå¥½åŠæ³•ï¼Œæ‰€ä»¥ç´¢æ€§ç¿»ç¿»æºç ï¼Œå¢è¿›ä¸€ä¸‹å¯¹å®ƒçš„äº†è§£ã€‚ç„¶åé¡ºä¾¿å†æ‰¾ä¸€æ‰¾è§£å†³æ–¹æ³•ã€‚</p>
<p>åŸºäºSpring Kafka <code>2.2.12.RELEASE</code></p>
<h2 id="1-å¦‚ä½•å®šä¹‰kafkaæ¶ˆè´¹è€…">1. å¦‚ä½•å®šä¹‰kafkaæ¶ˆè´¹è€…</h2>
<p>åœ¨Spring Kafkaæ¡†æ¶ä¸‹å®šä¹‰æ¶ˆè´¹è€…ç›¸å½“ç®€å•åˆ†åˆ«æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li>ç±»çº§åˆ«æ³¨è§£å®šä¹‰ï¼Œç›¸å…³æ³¨è§£ï¼š<code>@KafkaListener</code>ã€<code>@KafkaListeners</code>ã€<code>@KafkaHandler</code></li>
<li>æ–¹æ³•çº§åˆ«æ³¨è§£å®šä¹‰ï¼Œç›¸å…³æ³¨è§£ï¼š<code>@KafkaListener</code>ã€<code>@KafkaListeners</code></li>
</ul>
<p>è‡ªåŠ¨é…ç½®çš„ä»£ç å¯ä»¥å‚è€ƒå®˜æ–¹æ•™ç¨‹ï¼Œæ­¤å¤„ç•¥ã€‚</p>
<p>å…¶ä¸­ï¼Œ<code>@KafkaListeners</code>å¯ä»¥ç”±å¤šä¸ª<code>@KafkaListener</code>æ›¿ä»£ã€‚</p>
<p>ç±»çº§åˆ«æ³¨è§£å®šä¹‰ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Slf4j</span>
<span style="color:#a6e22e">@Component</span>
<span style="color:#a6e22e">@KafkaListener</span><span style="color:#f92672">(</span>topics <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DemoClassConsumer</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@KafkaHandler</span><span style="color:#f92672">(</span>isDefault <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle</span><span style="color:#f92672">(</span>String payload<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;default handle - receive data: {}&#34;</span><span style="color:#f92672">,</span> payload<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@KafkaHandler</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleString</span><span style="color:#f92672">(</span>String payload<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;string handle - receive data: {}&#34;</span><span style="color:#f92672">,</span> payload<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>@Component</code>æ³¨è§£æ˜¯å¿…åŠ çš„ï¼Œå› ä¸ºåªæœ‰Springçš„Beanæ‰ä¼šè§¦å‘Kafka Springçš„Beanåå¤„ç†æ–¹æ³•ã€‚<code>@KafkaListener</code>å£°æ˜æ¶ˆè´¹çš„topicç­‰ä¿¡æ¯ï¼Œè¯¥æ³¨è§£è¿˜åŒ…å«è®¸å¤šå…¶ä»–éå¸¸æœ‰ç”¨çš„å±æ€§ã€‚<code>@KafkaHandler</code>å£°æ˜å¤„ç†æ”¶åˆ°æ¶ˆæ¯çš„æ–¹æ³•ï¼Œå®ƒåªæœ‰ä¸€ä¸ªå±æ€§<code>isDefault</code>ã€‚å¯ä»¥ä½¿ç”¨<code>@KafkaHandler</code>å£°æ˜å¤šä¸ªæ–¹æ³•ï¼Œæ¯ä¸€ä¸ªæ–¹æ³•çš„å…¥å‚ç±»å‹å¿…é¡»ä¸ä¸€æ ·ï¼ŒSpring Kafkaå°†ä¾é æ”¶åˆ°æ¶ˆæ¯çš„ç±»å‹ï¼Œæ¥åˆ¤æ–­åº”è¯¥ç”¨å“ªä¸ªæ–¹æ³•å¤„ç†ã€‚å½“<code>isDefault = true</code>æ—¶ï¼ŒæŒ‡å®šè¯¥æ–¹æ³•ä¸ºæ‰€æœ‰ç±»å‹éƒ½åŒ¹é…ä¸åˆ°æ—¶çš„é»˜è®¤æ–¹æ³•ï¼Œç±»ä¼¼<code>switch</code>çš„<code>default</code>ï¼Œæ­¤æ—¶å…¥å‚å¯ä»¥ä¸å…¶å®ƒæ–¹æ³•å…¥å‚ç±»å‹ç›¸åŒã€‚</p>
<p>æ–¹æ³•çº§åˆ«çš„æ³¨è§£å®šä¹‰æ›´åŠ ç®€å•ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Slf4j</span>
<span style="color:#a6e22e">@Component</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DemoConsumer</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@KafkaListener</span><span style="color:#f92672">(</span>topics <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle</span><span style="color:#f92672">(</span>String message<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;receive message: {}&#34;</span><span style="color:#f92672">,</span> message<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ä½œä¸ºä¸¤ä¸ªæ¶ˆè´¹è€…çš„Demoï¼Œä¸Šé¢çš„ä»£ç å·²ç»è‡³å°‘å¯ä»¥â€œè·‘èµ·æ¥äº†â€ã€‚</p>
<h2 id="2-å¤šå®ä¾‹éƒ¨ç½²">2. å¤šå®ä¾‹éƒ¨ç½²</h2>
<p>å‡è®¾æœ‰ä¸€ä¸ªæ–°é—®é¢˜ï¼Œç±»ä¼¼â€œå¤šå®ä¾‹ä¸‹ä»…å•å®ä¾‹æ¶ˆè´¹ï¼Œä¸”åœ¨åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„â€ä¹‹ç±»çš„é—®é¢˜æ—¶ï¼Œä¸Šé¢çš„ç†è§£ç¨‹åº¦æ˜æ˜¾å°±ä¸å¤Ÿç”¨äº†ã€‚</p>
<p>â€œå¯¹ä¸€ä¸ªTopicï¼ŒåŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸‹æœåŠ¡çš„å¤šä¸ªå®ä¾‹ä¸­åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹æ¶ˆè´¹â€ï¼Œèƒ½ä¸èƒ½ç”¨å¤šä¸ªæ¶ˆè´¹è€…ç»„å®ç°ï¼ŸæŠ€æœ¯ä¸Šå¯ä»¥ï¼Œæ¯”å¦‚ç›´æ¥åœ¨<code>@KafkaListener</code>ä¸­ç”¨SpELè¡¨è¾¾å¼å®šä¹‰<code>groupId</code>ï¼Œè®©å…¶æ¯ä¸€ä¸ªå®ä¾‹éƒ½æ‹¥æœ‰ä¸€ä¸ªä¸åŒçš„æ¶ˆè´¹è€…ç»„ï¼Œè¿™æ ·ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸‹å°±åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…äº†ï¼Œè²Œä¼¼é—®é¢˜è§£å†³äº†ï¼Ÿ</p>
<p>å•çº¯å’¬æ–‡åš¼å­—ç¡®å®å¥½åƒé—®é¢˜è§£å†³äº†ï¼Œå› ä¸ºä¿è¯äº†åŒä¸€ä¸ª<code>groupId</code>ä¸‹æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚ä½†æ˜¯ï¼Œå†æƒ³æƒ³ï¼Œèƒ½ä¸èƒ½ä¿è¯æœ€åŸºæœ¬çš„ï¼Œä¸é‡å¤æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¸ä¸¢æ¶ˆæ¯ï¼ˆkafkaä¸­çš„æŸäº›æ¶ˆæ¯å¯èƒ½æ¶ˆè´¹ä¸åˆ°ï¼‰ï¼Ÿ</p>
<p>æ˜æ˜¾ä¸èƒ½ï¼Œå¤šä¸ª<code>groupId</code>å°±å·²ç»æ³¨å®šäº†æ‰€æœ‰ç»„ä¸‹é¢éƒ½ä¼šæ”¶åˆ°ç›¸åŒçš„æ¶ˆæ¯ï¼Œä¸ç®¡å¦‚ä½•å®šä¹‰æ¶ˆè´¹ç­–ç•¥ï¼Œearlest, latestï¼Œéƒ½æ— æµäºäº‹ï¼Œå¦‚æœç¡¬è¦æ‰‹åŠ¨åŒæ­¥ä¸åŒç»„ä¸‹çš„offsetï¼Œæˆ‘æƒ³å¸¦æ¥çš„æ–°é—®é¢˜ä¼šæ¯”è§£å†³è¿™ä¸ªé—®é¢˜æ›´å¤æ‚ã€‚</p>
<p>æœ‰æ²¡æœ‰ç®€å•çš„åŠæ³•ï¼Ÿ</p>
<p>è‚¯å®šæœ‰å•Šï¼Œåˆ†å¸ƒå¼é” + åŠ¨æ€æ¶ˆè´¹è€…ï¼ŒæŠ¢åˆ°é”çš„å®ä¾‹æ‰èƒ½å¼€å¯æ¶ˆè´¹è€…ã€‚</p>
<p>åˆ†å¸ƒå¼é”å¥½åŠï¼Œå¼•å…¥redissonï¼Œå•çº¿ç¨‹æŒç»­æŠ¢é”ï¼Œé…ç½®+ä»£ç ï¼Œä¸è¶…è¿‡50è¡Œï¼ŒåŒ…æ‹¬ç©ºè¡Œã€‚</p>
<p>é‚£å¦‚ä½•åŠ¨æ€å¼€å¯æ¶ˆè´¹è€…ï¼Ÿ</p>
<h2 id="3-åŠ¨æ€æ¶ˆè´¹è€…">3. åŠ¨æ€æ¶ˆè´¹è€…</h2>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒKafkaçš„æ¶ˆè´¹æ¨¡å¼ä¸ºå®¢æˆ·ç«¯ä¸æ–­çš„æ‹‰æ¶ˆæ¯ã€‚è¿™é‡Œè¯´çš„åŠ¨æ€ï¼ŒæŒ‡å¯ä»¥åŠ¨æ€å¼€å¯å’Œå…³é—­è¿™ä¸ªæ¶ˆè´¹è€…ï¼Œä¸æ˜¯åœ¨æ¶ˆæ¯å¤„ç†æ–¹æ³•ä¸­åˆ¤æ–­æ˜¯å¦è¯¥æ¶ˆè´¹ï¼Œè¿™æ ·çš„å®ç°å¤ªéš¾çœ‹ï¼Œè€Œæ˜¯è¦å…³é—­æ‹‰è¿™ä¸ªè¿‡ç¨‹ï¼Œåˆæˆ–è€…ï¼Œå¯ä»¥æ‹‰æ¶ˆæ¯ï¼Œä½†æ˜¯ä¸èƒ½æ¶ˆè´¹ï¼Œä¸èƒ½æäº¤offsetï¼Œä½†æ˜¯è¿™æ ·æœ‰å¯èƒ½æŠŠå†…å­˜è€—å°½ã€‚</p>
<p>å¦‚æœä½¿ç”¨åŸç”ŸKafkaå®¢æˆ·ç«¯æ¥å®ç°ï¼Œå½“ç„¶å¯ä»¥ï¼Œä½†æ˜¯å·¥ä½œé‡å¯èƒ½ä¼šæ¯”è¾ƒå¤§ï¼Œæ—¢ç„¶å¼•å…¥äº†Spring Kafkaè¿™ä¸ªæ¡†æ¶ï¼Œé‚£å°±è¦å‘æŒ¥è¿™ä¸ªæ¡†æ¶çš„ä»·å€¼ï¼Œæ¡†æ¶èƒ½ä¸èƒ½å®ç°ï¼Œå¦‚ä½•å®ç°ï¼Ÿ</p>
<p>æ¡†æ¶å½“ç„¶èƒ½ã€‚</p>
<p>å¾ˆç®€å•çš„ä¸€ä¸ªå‚æ•°ï¼Œè¯·çœ‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">KafkaListener<span style="color:#f92672">(</span>topics <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;test-consumer&#34;</span><span style="color:#f92672">,</span> autoStartup <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">)</span>
</code></pre></div><p><code>autoStartup</code>è¡¨ç¤ºæ˜¯å¦åœ¨å¯åŠ¨åè‡ªåŠ¨å¼€å¯æ¶ˆè´¹è€…ï¼Œå¦ä¸å°±å®Œäº‹äº†ï¼Œå¤§å®¶éƒ½å…ˆåˆ«æ¶ˆè´¹ï¼ŒæŠ¢å®Œé”å†æ¶ˆè´¹ã€‚</p>
<p>æŠ¢é”è¿‡ç¨‹ä¸åœ¨è®¨è®ºèŒƒå›´ã€‚</p>
<p>å‡å¦‚å…¶ä¸­çš„ä¸€ä¸ªå®ä¾‹æŠ¢åˆ°é”äº†ï¼Œæ€ä¹ˆèƒ½æ‰“å¼€å®ƒå‘¢ï¼Ÿè¯·çœ‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Slf4j</span>
<span style="color:#a6e22e">@Service</span>
<span style="color:#a6e22e">@AllArgsConstructor</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumerManager</span> <span style="color:#66d9ef">implements</span> ApplicationRunner <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> KafkaListenerEndpointRegistry endpointRegistry<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ApplicationArguments args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getDistributeLockSuccessfully<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            endpointRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span> <span style="color:#75715e">//æ­¤æ–¹æ³•ä¼šå°†æ²¡è¿è¡Œçš„æ¶ˆè´¹è€…å…¨éƒ¨æ‰“å¼€
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å°±æ˜¯è¿™ä¹ˆeasyã€‚</p>
<p>å†æ¥å›å½’ä¸€ä¸‹é‚£ä¸¤ä¸ªåŸºæœ¬é—®é¢˜ä¼šä¸ä¼šé‡å¤æ¶ˆè´¹ï¼Œä¼šä¸ä¼šä¸¢æ¶ˆæ¯ã€‚</p>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒåŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œè‚¯å®šä¸ä¼šã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œç»å¤§æ¦‚ç‡ä¸ä¼šï¼Œä¾èµ–äºå…·ä½“é…ç½®å’Œä¸šåŠ¡ä»£ç çš„å®ç°ã€‚</p>
<p>é’ˆå¯¹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œçœ‹ä¸€çœ‹Spring Kafkaæ‹‰å–åˆ°æ¶ˆæ¯åï¼Œæ˜¯å¦‚ä½•ä¸¢ç»™KafkaListenerä»¬æ¶ˆè´¹çš„ã€‚çœ‹ä¸€çœ‹<code>KafkaMessageListenerContainer.invokeOnMessage(final ConsumerRecord&lt;K, V&gt; record, @SuppressWarnings(RAWTYPES) @Nullable Producer producer)</code>çš„å®ç°ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invokeOnMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ConsumerRecord<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> record<span style="color:#f92672">,</span> <span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span>RAWTYPES<span style="color:#f92672">)</span> <span style="color:#a6e22e">@Nullable</span> Producer producer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â <span style="color:#75715e">// (1)æ£€æŸ¥keyå’Œvalueæ˜¯å¦æ˜¯ä¸€ä¸ªDeserializationExceptionå¼‚å¸¸
</span><span style="color:#75715e"></span>Â Â Â Â <span style="color:#75715e">// (2)å¦‚æœkeyå’Œvalueä¸ºç©ºï¼Œåˆ¤æ–­å…¶headersä¸­æ˜¯å¦åŒ…å«Springååºåˆ—åŒ–å¼‚å¸¸
</span><span style="color:#75715e"></span>Â Â Â Â <span style="color:#75715e">// (3)è°ƒç”¨å®é™…çš„æ¶ˆæ¯å¤„ç†é€»è¾‘
</span><span style="color:#75715e"></span>Â Â Â Â doInvokeOnMessage<span style="color:#f92672">(</span>record<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
Â Â Â Â 
Â Â Â Â <span style="color:#75715e">// (4)commit offset
</span><span style="color:#75715e"></span>Â Â Â Â ackCurrent<span style="color:#f92672">(</span>record<span style="color:#f92672">,</span> producer<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>æ˜¯çš„ï¼Œåœ¨ï¼ˆ3ï¼‰çš„æ—¶å€™ï¼Œå³å®é™…çš„å¤„ç†ä¸šåŠ¡ä»£ç åï¼ŒSpring Kafkaæ‰ä¼šå¸®ä½ æäº¤offsetï¼Œè€Œå¦‚æœåœ¨ï¼ˆ3ï¼‰çš„æ—¶å€™ï¼Œä½ æŠ›äº†ä¸ªå¼‚å¸¸ï¼Œé‚£æ˜¯ä¸æ˜¯å°±ä¸ä¼šæäº¤äº†ï¼Ÿæ˜¯ä¸æ˜¯ä¸šåŠ¡ç«¯åªè¦å¤„ç†å¤±è´¥åæŠ›ä¸ªå¼‚å¸¸å‡ºæ¥å°±ä¸‡äº‹å¤§å‰å•¦ï¼Ÿ</p>
<p>éä¹Ÿï¼Œç»§ç»­ç¿»å®ƒçš„è°ƒç”¨è€…ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> RuntimeException <span style="color:#a6e22e">doInvokeRecordListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ConsumerRecord<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> record<span style="color:#f92672">,</span><span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span>RAW_TYPES<span style="color:#f92672">)</span> Producer producer<span style="color:#f92672">,</span>Iterator<span style="color:#f92672">&lt;</span>ConsumerRecord<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> iterator<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// (1) 
</span><span style="color:#75715e"></span>Â Â Â Â Â Â Â Â invokeOnMessage<span style="color:#f92672">(</span>record<span style="color:#f92672">,</span> producer<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RuntimeException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// (2)
</span><span style="color:#75715e"></span>Â Â Â Â Â Â Â Â <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">containerProperties</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAckOnError</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">autoCommit</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> producer <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â Â Â Â Â Â Â Â Â ackCurrent<span style="color:#f92672">(</span>record<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
Â Â Â Â Â Â Â Â <span style="color:#f92672">}</span>

Â Â Â Â Â Â Â Â <span style="color:#75715e">// (3)å„ç§å¼‚å¸¸å¤„ç†balabala
</span><span style="color:#75715e"></span>        <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
Â Â Â Â <span style="color:#f92672">}</span>
Â Â Â Â <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å¾ˆä¸å¹¸ï¼Œ<code>invokeOnMessage(record, producer)</code>æŠ›å‡ºçš„å¼‚å¸¸è¢«æ•è·äº†ï¼Œè€Œä¸”åœ¨æ»¡è¶³æŸäº›æ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œå®ƒä»ç„¶ä¼šå¸®ä½ æäº¤offsetã€‚so sadğŸ¶ã€‚å…·ä½“çœ‹çœ‹æ˜¯ä»€ä¹ˆæ¡ä»¶<code>isAckOnError()</code>ï¼Œ<code>autoCommit</code>ï¼Œ<code>producer</code>ï¼Œå…¶ä¸­å¦‚æœkafkaæ¶ˆè´¹æ—¶æ²¡æœ‰å®šä¹‰äº‹åŠ¡ï¼Œé‚£<code>producer == null</code>ï¼Œ<code>autoCommit</code>çš„å€¼ï¼Œå–å†³äºspirngé…ç½®ä¸­<code>spring.kafka.consumer.enable-auto-commit</code> çš„å€¼ï¼Œé»˜è®¤ä¸ºfalseã€‚æˆ‘å»ï¼Œåä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³äº†ï¼Œç»§ç»­çœ‹<code>isAckOnError()</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isAckOnError</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ackOnError</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>
                <span style="color:#f92672">!</span><span style="color:#f92672">(</span>AckMode<span style="color:#f92672">.</span><span style="color:#a6e22e">MANUAL_IMMEDIATE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ackMode</span><span style="color:#f92672">)</span> Â Â Â Â 
                <span style="color:#f92672">|</span><span style="color:#f92672">|</span>AckMode<span style="color:#f92672">.</span><span style="color:#a6e22e">MANUAL</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ackMode</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å…¶ä¸­<code>this.ackOnError</code>é»˜è®¤ä¸º<code>true</code>ï¼Œè®©æ•´ä¸ªæ–¹æ³•è¿”å›<code>false</code>çš„å”¯ä¸€æ–¹æ³•ï¼Œæ˜¯å®šä¹‰<code>this.ackMode</code>ä¸º<code>MANUAL_IMMEDIATE</code>æˆ–<code>MANUAL</code>ï¼Œè€Œå…¶é»˜è®¤ä¸º<code>BATCH</code>ï¼Œæ›´åŠ sadäº†ğŸ¶ã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœé…ç½®ä¸å½“ï¼Œåˆæ²¡æœ‰äº‹åŠ¡ä¿è¯ï¼Œåœ¨ä¸šåŠ¡é€»è¾‘å¤„ç†å¼‚å¸¸åï¼Œæ¯”å¦‚è¦å­˜ä¸ªæ•°æ®åº“ç»“æœæ²¡å­˜è¿›å»è¿˜æŠ›äº†ä¸ªå¼‚å¸¸ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šä¸¢æ•°æ® - kafkaçš„æ•°æ®å·²ç»æ¶ˆè´¹äº†ï¼Œå´æ²¡æœ‰æˆåŠŸå…¥åº“ã€‚</p>
<p>è™½ç„¶Spring Kafkaä¿è¯äº†å¤§éƒ¨åˆ†æƒ…å†µä¸‹çš„å¥å£®ï¼Œä½†æ˜¯æ­£ç¡®çš„é…ç½®å’Œæ­£ç¡®çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ä¹Ÿå¾ˆé‡è¦ã€‚å¦åˆ™ä¸¢æ¶ˆæ¯åœ¨æ‰€éš¾å…ã€‚</p>
<h2 id="4-ackæ¨¡å¼ä¸é”™è¯¯å¤„ç†">4. Ackæ¨¡å¼ä¸é”™è¯¯å¤„ç†</h2>
<p>Spring Kafkaæä¾›çš„ACKæ¨¡å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<table>
<thead>
<tr>
<th>ACKæ¨¡å¼</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>RECORD</td>
<td>æ¯æ¡æ¶ˆæ¯å¤„ç†å®Œåé©¬ä¸Šæäº¤offset</td>
</tr>
<tr>
<td>BATCH</td>
<td>ä¸‹ä¸€æ¬¡pollå‰ï¼Œå°†å…¨éƒ¨æäº¤ä¸Šä¸€æ¬¡pollçš„æ¶ˆæ¯ï¼Œä¸ç®¡æœ‰æ²¡æœ‰çœŸæ­£æ¶ˆè´¹åˆ°ğŸ¤£</td>
</tr>
<tr>
<td>TIME</td>
<td>æŒ‰æ—¶æäº¤offset</td>
</tr>
<tr>
<td>COUNT</td>
<td>æŒ‰æ¶ˆæ¯æ•°æäº¤</td>
</tr>
<tr>
<td>COUNT_TIME</td>
<td>å³ TIME || COUNT å°±æäº¤</td>
</tr>
<tr>
<td>MANUAL</td>
<td>æ‰‹åŠ¨æäº¤ï¼Œæ‰¹é‡æ¨¡å¼</td>
</tr>
<tr>
<td>MANUAL_IMMEDIATE</td>
<td>æ‰‹åŠ¨é©¬ä¸Šæäº¤</td>
</tr>
</tbody>
</table>
<p>é»˜è®¤é…ç½®ä¸‹ï¼ŒSpringKafkaå°†ä½¿ç”¨è‡ªåŠ¨æäº¤ï¼Œä¸”Ackæ¨¡å¼ä¸ºBATCHï¼Œæ‰€ä»¥è¿˜æ˜¯å¾ˆå®¹æ˜“ä¸¢æ¶ˆæ¯ã€‚</p>
<p>é»˜è®¤é…ç½®çš„ErrorHandlerï¼Œä»…ä»…åªæ˜¯æ‰“å°ä¸€ä¸‹æ—¥å¿—ï¼Œä½†æ˜¯Spring Kafkaè¿˜æä¾›äº†å‡ ä¸ªé»˜è®¤å®ç°ã€‚</p>
<p><img src="https://raw.githubusercontent.com/XIEJD/blog-images/master/2020/02/23-23-13-31-ErrorHandler.png" alt="ErrorHandler.png"></p>
<ul>
<li>
<p><code>ContainerStoppingErrorHandler</code></p>
</li>
<li>
<p><code>SeekToCurrentErrorHandler</code></p>
</li>
</ul>
<p>è¿™äº›å®ç°å¿…é¡»å£°æ˜ä¸ºBeanæ‰èƒ½æ³¨å…¥åˆ°é…ç½®ä¸­ã€‚</p>
<h2 id="5-dive-in-src">5. Dive In Src</h2>
<p>ç»Ÿç­¹å…¼é¡¾ä¸€ä¸‹ï¼Œå¦‚ä¸Šåˆ†æï¼Œé…ç½®+ä¸šåŠ¡ä»£ç è´¨é‡èƒ½æ˜¾è‘—å½±å“Kafkaæ¶ˆæ¯çš„æ¶ˆè´¹å¥å£®æ€§ã€‚ä¸»è¦åœ¨å››ä¸ªæ–¹é¢ï¼š</p>
<ol>
<li>ã€T1ã€‘offsetæäº¤</li>
<li>ã€T2ã€‘å¼‚å¸¸å¤„ç†</li>
<li>ã€T3ã€‘äº‹åŠ¡</li>
</ol>
<p>ä¸ºäº†æ›´å¥½çš„å¼„æ˜ç™½Spring Kafkaæ˜¯å¦‚ä½•è®©è¿™äº›é…ç½®å½±å“æ¶ˆè´¹è€…çš„ï¼Œä»¥åŠKafkaListeneræ‰€æ ‡æ³¨çš„è¿™äº›æ–¹æ³•æˆ–è€…ç±»å¦‚ä½•æ‰èƒ½æ›´å¥½çš„æäº¤offsetï¼Œå†æ·±å…¥ä¸€ç‚¹ï¼Œä¸å¦¨å†ä»æºç å…¥æ‰‹ï¼Œä»å®šä¹‰æ¶ˆè´¹è€…çš„â€œå§‹ä½œä¿‘è€…â€ï¼Œ<code>@KafkaListener</code>å¼€å§‹ï¼Œå¼„æ¸…æ¥šï¼Œæ¶ˆè´¹è€…æ˜¯å¦‚ä½•é…ç½®çš„ï¼Œå¦‚ä½•æ³¨å…¥çš„ï¼Œå¦‚ä½•ç®¡ç†çš„ï¼Œå¦‚ä½•å¯åŠ¨ï¼Œå¦‚ä½•åœæ­¢ï¼Œå¦‚ä½•æœ€åå°†æ¶ˆæ¯ä¼ ç»™å®é™…å¤„ç†æ–¹æ³•ï¼Œæœ€åå¦‚ä½•å¤„ç†offsetï¼Œå¦‚ä½•å¤„ç†å¼‚å¸¸çš„ã€‚</p>
<p>å°†é—®é¢˜åˆ†ä¸ªç±»ï¼š</p>
<ol>
<li>ã€Q1ã€‘Kafkaæ¶ˆè´¹è€…çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</li>
<li>ã€Q2ã€‘Kafkaæ¶ˆè´¹è€…çš„å¼‚å¸¸å¤„ç†</li>
<li>ã€Q3ã€‘Kafkaäº‹åŠ¡ ï¼ˆå•ç‹¬å¼€ç¯‡ï¼Œæ­¤ç¯‡ä»…è®¨è®ºæ— äº‹åŠ¡æƒ…å†µï¼‰</li>
</ol>
<h3 id="41-æ³¨è§£æ‰«æ">4.1 æ³¨è§£æ‰«æ</h3>
<p><code>@EnableKafka</code>å°†å®é™…å¼•å…¥Kafka Springçš„æ³¨è§£æ‰«æé…ç½®ã€‚</p>
<p>è¯¥æ³¨è§£å¯ä»¥æ”¾ç½®åœ¨ä¸»ç±»ä¸Šï¼Œæˆ–è€…å…¶ä»–<code>@Configuration</code>ä¸Šï¼Œç”šè‡³å¯ä»¥ä¸æ”¾ï¼Œè‡³äºä¸ºå•¥å¯ä»¥ä¸æ”¾ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ç¿»ç¿»<code>KafkaAutoConfiguration</code>çš„æºç ã€‚</p>
<p>å¼€å¯Spring Kafkaä¸­<code>@EnableKafka</code>æ³¨è§£åï¼Œå°†è§¦å‘<code>KafkaBootstrapConfiguration</code>è‡ªåŠ¨é…ç½®ï¼Œè¿™é…ç½®å¹²äº†å•¥å‘¢ï¼Ÿç›¸å½“ç®€å•ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KafkaBootstrapConfiguration</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;rawtypes&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#a6e22e">@Bean</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> KafkaListenerConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">KAFKA_LISTENER_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style="color:#f92672">)</span>
    <span style="color:#a6e22e">@Role</span><span style="color:#f92672">(</span>BeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLE_INFRASTRUCTURE</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> KafkaListenerAnnotationBeanPostProcessor <span style="color:#a6e22e">kafkaListenerAnnotationProcessor</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> KafkaListenerAnnotationBeanPostProcessor<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Bean</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> KafkaListenerConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">KAFKA_LISTENER_ENDPOINT_REGISTRY_BEAN_NAME</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> KafkaListenerEndpointRegistry <span style="color:#a6e22e">defaultKafkaListenerEndpointRegistry</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> KafkaListenerEndpointRegistry<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>çœ‹èµ·æ¥ç¡®å®ç›¸å½“ç®€å•å‘€ï¼Œå®šä¹‰äº†ä¸¤ä¸ªBeanï¼Œ<code>KafkaListenerAnnotationBeanPostProcessor</code>å’Œ<code>KafkaListenerEndpointRegistry</code>ï¼Œé€šè¿‡æºç ä¸Šçš„æ–‡æ¡£ï¼Œå¯ä»¥æ¸…æ¥šçš„çŸ¥é“è¿™ä¸¤ä¸ªBeançš„ä½œç”¨ã€‚</p>
<p><code>KafkaListenerAnnotationBeanPostProcessor</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Bean post-processor that registers methods annotated with {@link KafkaListener}
</span><span style="color:#75715e"> * to be invoked by a Kafka message listener container created under the covers
</span><span style="color:#75715e"> * by a {@link org.springframework.kafka.config.KafkaListenerContainerFactory}
</span><span style="color:#75715e"> * according to the parameters of the annotation.
</span><span style="color:#75715e"> */</span>
</code></pre></div><p>æ„æ€æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªBeanåå¤„ç†å™¨ï¼Œè¿™ä¸ªåå¤„ç†å™¨ä¸“é—¨ç”¨æ¥æ³¨å†Œé‚£äº›è¢«@KafkaListeneræ ‡æ³¨çš„æ–¹æ³•ï¼ˆæ„Ÿè§‰æ–‡æ¡£é‡Œæ¼äº†ä¸€ç‚¹ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯ç±»ï¼‰ï¼Œè¿™äº›æ–¹æ³•å°†ä¼šè¢«kafkaæ¶ˆæ¯ç›‘å¬å®¹å™¨æ‰€è§¦å‘ï¼Œè€Œè¿™äº›å®¹å™¨å½’äº<code>KafkaListenerContainerFactory</code>ç®¡ç†ã€‚</p>
<p><code>KafkaListenerEndpointRegistry</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Creates the necessary {@link MessageListenerContainer} instances for the
</span><span style="color:#75715e"> * registered {@linkplain KafkaListenerEndpoint endpoints}. Also manages the
</span><span style="color:#75715e"> * lifecycle of the listener containers, in particular within the lifecycle
</span><span style="color:#75715e"> * of the application context.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * &lt;p&gt;Contrary to {@link MessageListenerContainer}s created manually, listener
</span><span style="color:#75715e"> * containers managed by registry are not beans in the application context and
</span><span style="color:#75715e"> * are not candidates for autowiring. Use {@link #getListenerContainers()} if
</span><span style="color:#75715e"> * you need to access this registry&#39;s listener containers for management purposes.
</span><span style="color:#75715e"> * If you need to access to a specific message listener container, use
</span><span style="color:#75715e"> * {@link #getListenerContainer(String)} with the id of the endpoint.
</span><span style="color:#75715e"> */</span>
</code></pre></div><p>å“å‘€å¦ˆå‘€ï¼Œå…¨æ˜¯é˜…è¯»ç†è§£ğŸ¤£ã€‚</p>
<p>è¿™ä¸¤æ®µè¯çš„å¤§æ¦‚æ„æ€æ˜¯ï¼Œè¿™ä¸ªç±»ç”¨äºä¸ºé‚£äº›å·²ç»æ³¨å†Œåˆ°è¿™ä¸ªç±»é‡Œçš„endpointsåˆ›å»ºå¿…è¦çš„Kafkaæ¶ˆæ¯ç›‘å¬å®¹å™¨ï¼ˆæ˜¯ä¸æ˜¯å’Œä¸Šé¢é‚£ä¸ªBeanæœ‰é‚£ä¹ˆç‚¹å…³ç³»äº†ï¼‰ï¼ŒåŒæ—¶ä¹Ÿå°†ç®¡ç†è¿™äº›Kafkaæ¶ˆæ¯ç›‘å¬å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™äº›è¢«ç®¡ç†çš„æ¶ˆæ¯ç›‘å¬å®¹å™¨ä¸æ˜¯ä»¥Beançš„å½¢å¼å­˜åœ¨äºåº”ç”¨ä¸Šä¸‹æ–‡ä¸­ï¼Œæ‰€ä»¥æ˜¯æ— æ³•è¢«è‡ªåŠ¨æ³¨å…¥çš„ï¼Œå¦‚æœéœ€è¦å¼•ç”¨è¿™äº›æ¶ˆæ¯ç›‘å¬å®¹å™¨ï¼Œéœ€è¦ç”¨åˆ°æ­¤ç±»çš„<code>getListenerContainers()</code>æ–¹æ³•ã€‚</p>
<p>ä¸¤ä¸ªç±»åˆ†åˆ«è§£å†³äº†Q1å’ŒQ2ï¼Œå…ˆçœ‹Q1ã€‚</p>
<p><code>KafkaListenerAnnotationBeanPostProcessor</code>å®ç°äº†4ä¸ªSpringç›¸å…³çš„æ¥å£ï¼Œå…¶ä¸­æœ€é‡è¦çš„æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯<code>SmartInitializingSingleton</code>ï¼Œå¦ä¸€ä¸ªæ˜¯<code>BeanPostProcessor</code>ã€‚å‰è€…ç”¨äºæå‰å®ç°å•ä¾‹Beançš„åˆå§‹åŒ–ï¼Œåè€…ç”¨äºå¢å¼ºBeanã€‚</p>
<p>åœ¨åˆ†æå®ƒä»¬çš„æºç å‰ï¼Œæœ‰ä¸€ä»¶äº‹æƒ…å¿…é¡»ææ¸…æ¥šï¼ŒSpringæä¾›çš„è¿™äº›é’©å­ï¼Œä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨ï¼Œè°å…ˆè°ƒç”¨è°åè°ƒç”¨ï¼Ÿå¦‚æœæ— æ³•ç†è§£ä»–ä»¬çš„å‰åå…³ç³»ï¼Œç†è§£ä¸Šå°†å‡ºç°å·¨å¤§çš„åå·®ã€‚æ­¤å¤„ä¸åšè¿‡å¤šæ¢è®¨ã€‚</p>
<p>å¦‚æœæ²¡è€å¿ƒæŸ¥èµ„æ–™ï¼Œç›´æ¥æ–­ç‚¹ï¼Œæ­¤å¤„æœ‰ä¸‰ä¸ªæ–¹æ³•éœ€è¦ææ¸…æ¥šè°ƒç”¨é¡ºåºï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li><code>SmartInitializingSingleton.afterSingletonsInstantiated()</code></li>
<li><code>BeanPostProcessor.postProcessBeforeInitialization()</code></li>
<li><code>BeanPostProcessor.postProcessAfterInitialization()</code></li>
</ul>
<p>å¾ˆæ˜æ˜¾<code>BeanPostProcessor</code>çš„å…ˆåé¡ºåºæ˜¾è€Œæ˜“è§ã€‚é€šè¿‡æ–­ç‚¹å‘ç°ï¼š<code>postProcessBeforeInitialization()</code> -&gt; <code>postProcessAfterInitialization()</code> -&gt; <code>afterSingletonsInstantiated()</code>ã€‚ï¼ˆIDEAçœŸé¦™</p>
<p>æ‰€ä»¥å…ˆçœ‹å®ç°äº†<code>BeanPostProcessor</code>æ¥å£çš„æ–¹æ³•ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">postProcessAfterInitialization</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Object bean<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String beanName<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
Â Â Â Â <span style="color:#75715e">//ä¸€ä¸ªå·¨å¤§çš„åˆ¤æ–­
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#f92672">!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">nonAnnotatedClasses</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â Â Â Â Â <span style="color:#75715e">// è·å–åŸå§‹Beanç±»å‹ï¼Œä»¥é˜²è¢«ä»£ç†
</span><span style="color:#75715e"></span>        Class<span style="color:#f92672">&lt;</span><span style="color:#f92672">?</span><span style="color:#f92672">&gt;</span> targetClass <span style="color:#f92672">=</span> AopUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getTargetClass</span><span style="color:#f92672">(</span>bean<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
Â Â Â Â Â Â Â Â <span style="color:#75715e">//å¼€å§‹å¹²å®äº‹äº†ï¼Œæ‰¾ç±»çº§åˆ«çš„@KafkaListeneræ³¨è§£
</span><span style="color:#75715e"></span>Â Â Â Â Â Â Â Â Collection<span style="color:#f92672">&lt;</span>KafkaListener<span style="color:#f92672">&gt;</span> classLevelListeners <span style="color:#f92672">=</span> findListenerAnnotations<span style="color:#f92672">(</span>targetClass<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

Â Â Â Â Â Â Â Â <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> hasClassLevelListeners <span style="color:#f92672">=</span> classLevelListeners<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">;</span>
Â Â Â Â Â Â Â Â <span style="color:#66d9ef">final</span> List<span style="color:#f92672">&lt;</span>Method<span style="color:#f92672">&gt;</span> multiMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

Â Â Â Â Â Â Â Â <span style="color:#75715e">//åˆå¹²äº†ä»¶å®äº‹ï¼Œæ‰¾æ–¹æ³•çº§åˆ«çš„@KafkaListeneræ³¨è§£
</span><span style="color:#75715e"></span>Â Â Â Â Â Â Â Â Map<span style="color:#f92672">&lt;</span>Method<span style="color:#f92672">,</span> Set<span style="color:#f92672">&lt;</span>KafkaListener<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> annotatedMethods <span style="color:#f92672">=</span> MethodIntrospector<span style="color:#f92672">.</span><span style="color:#a6e22e">selectMethods</span><span style="color:#f92672">(</span>targetClass<span style="color:#f92672">,</span><span style="color:#f92672">(</span>MethodIntrospector<span style="color:#f92672">.</span><span style="color:#a6e22e">MetadataLookup</span><span style="color:#f92672">&lt;</span>Set<span style="color:#f92672">&lt;</span>KafkaListener<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">)</span> method <span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
                        Set<span style="color:#f92672">&lt;</span>KafkaListener<span style="color:#f92672">&gt;</span> listenerMethods <span style="color:#f92672">=</span> findListenerAnnotations<span style="color:#f92672">(</span>method<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span><span style="color:#f92672">!</span>listenerMethods<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">?</span> listenerMethods <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
Â Â Â Â Â Â Â Â <span style="color:#f92672">}</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

Â Â Â Â Â Â Â Â <span style="color:#75715e">//å¦‚æœæœ‰ç±»çº§åˆ«çš„æ³¨è§£ï¼Œåˆ™è¿˜éœ€è¦ç¡®å®šæ‰¾åˆ°å…¶ä¸­çš„@KafkaHandleræ³¨è§£ï¼Œæ˜¯ä¸æ˜¯å’Œç¬¬ä¸€ç« çš„ä½¿ç”¨æ–¹æ³•å¯¹ä¸Šäº†
</span><span style="color:#75715e"></span>Â Â Â Â Â Â Â Â <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasClassLevelListeners<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Set<span style="color:#f92672">&lt;</span>Method<span style="color:#f92672">&gt;</span> methodsWithHandler <span style="color:#f92672">=</span> MethodIntrospector<span style="color:#f92672">.</span><span style="color:#a6e22e">selectMethods</span><span style="color:#f92672">(</span>targetClass<span style="color:#f92672">,</span><span style="color:#f92672">(</span>ReflectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">MethodFilter</span><span style="color:#f92672">)</span> method <span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span> AnnotationUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">findAnnotation</span><span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> KafkaHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                multiMethods<span style="color:#f92672">.</span><span style="color:#a6e22e">addAll</span><span style="color:#f92672">(</span>methodsWithHandler<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
Â Â Â Â Â Â Â Â <span style="color:#f92672">}</span>

Â Â Â Â Â Â Â Â <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>annotatedMethods<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â Â Â Â Â Â Â Â Â <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">nonAnnotatedClasses</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
Â Â Â Â Â Â Â Â Â Â Â Â <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">logger</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isTraceEnabled</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">logger</span><span style="color:#f92672">.</span><span style="color:#a6e22e">trace</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;No @KafkaListener annotations found on bean type: &#34;</span> <span style="color:#f92672">+</span> bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
Â Â Â Â Â Â Â Â <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//å¦‚æœæ‰¾åˆ°äº†æ–¹æ³•çº§åˆ«çš„æ³¨è§£ï¼Œä¸¢ç»™åˆ«äººå†å»åŒ…è£…
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>Method<span style="color:#f92672">,</span> Set<span style="color:#f92672">&lt;</span>KafkaListener<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> annotatedMethods<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Method method <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>KafkaListener listener <span style="color:#f92672">:</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span style="color:#75715e">//ï¼ˆ1ï¼‰åŒ…è£…æ–¹æ³•çº§åˆ«çš„æ¶ˆè´¹è€…
</span><span style="color:#75715e"></span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â processKafkaListener<span style="color:#f92672">(</span>listener<span style="color:#f92672">,</span> method<span style="color:#f92672">,</span> bean<span style="color:#f92672">,</span> beanName<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
Â Â Â Â Â Â Â Â Â Â Â Â <span style="color:#f92672">}</span>

Â Â Â Â Â Â Â Â <span style="color:#75715e">//å¦‚æœæœ‰ç±»çº§åˆ«çš„æ³¨è§£ï¼Œä¹Ÿä¸¢ç»™åˆ«äººå†å»åŒ…è£…ã€‚
</span><span style="color:#75715e"></span>Â Â Â Â Â Â Â Â <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasClassLevelListeners<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Â Â Â Â <span style="color:#75715e">//ï¼ˆ2ï¼‰åŒ…è£…ç±»çº§åˆ«çš„æ¶ˆè´¹åˆ™
</span><span style="color:#75715e"></span>Â Â Â Â Â Â Â Â Â Â Â Â processMultiMethodListeners<span style="color:#f92672">(</span>classLevelListeners<span style="color:#f92672">,</span> multiMethods<span style="color:#f92672">,</span> bean<span style="color:#f92672">,</span> beanName<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
Â Â Â Â Â Â Â Â <span style="color:#f92672">}</span>
Â Â Â Â <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>è¿™å®ç°å°±è·Ÿå†™å¤§çº²ä¼¼çš„ï¼Œåœ¨å…¶ä»–beanå®Œæˆåˆå§‹åŒ–åï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªåå¤„ç†æ–¹æ³•ï¼Œè¿™ä¸ªåå¤„ç†æ–¹æ³•ä¼šæ‰¾åˆ°æ‰€æœ‰è¢«<code>@KafkaListener</code>æ ‡æ³¨çš„æ–¹æ³•ï¼Œä»¥åŠæ‰€æœ‰è¢«<code>@KafkaListener</code>æ ‡æ³¨çš„ç±»ä¸­çš„<code>@KafkaHandler</code>ä¿®é¥°çš„æ–¹æ³•ï¼Œç„¶åç»§ç»­å¯¹ä»–ä»¬è¿›è¡ŒåŒ…è£…ã€‚</p>
<p>ï¼ˆ1ï¼‰æ‰¾åˆ°æ–¹æ³•çº§åˆ«çš„æ¶ˆè´¹è€…åï¼Œ<code>processKafkaListener</code>å°†è¯¥æ–¹æ³•åŒ…è£…åˆ°<code>MethodKafkaListenerEndpoint</code>ç±»å®ä¾‹åŒ–çš„endpointä¸­ï¼Œä¹‹åä»æ³¨è§£ä¸­å°†å„ä¸ªå‚æ•°è§£æå‡ºæ¥èµ‹ç»™endpointï¼Œæœ€åï¼Œè¯¥endpointä¼šè¢«æ³¨å†Œåˆ°<code>KafkaListenerEndpointRegistrar</code>Beanä¸­ï¼Œè°ƒç”¨çš„æ˜¯å…¶<code>registerEndpoint()</code>æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ª<code>KafkaListenerEndpointRegistry</code>çš„å¸®åŠ©ç±»ã€‚å½“endpointæ³¨å†Œåˆ°Registrarä¸­çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿç»§ç»­çœ‹æºç ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerEndpoint</span><span style="color:#f92672">(</span>KafkaListenerEndpoint endpoint<span style="color:#f92672">,</span> KafkaListenerContainerFactory<span style="color:#f92672">&lt;</span><span style="color:#f92672">?</span><span style="color:#f92672">&gt;</span> factory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">// å‚æ•°æ ¡éªŒ
</span><span style="color:#75715e"></span>  <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>

  <span style="color:#75715e">// æ‰“åŒ…endpointå’Œå…¶å¯¹åº”çš„å·¥å‚ï¼Œæ–¹ä¾¿å­˜å‚¨
</span><span style="color:#75715e"></span>  KafkaListenerEndpointDescriptor descriptor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> KafkaListenerEndpointDescriptor<span style="color:#f92672">(</span>endpoint<span style="color:#f92672">,</span> factory<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

  <span style="color:#75715e">// åŒæ­¥ä¸€ä¸‹ArrayListï¼Œé˜²æ­¢è¢«åŒæ—¶æ“ä½œ
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">endpointDescriptors</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">startImmediately</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">endpointRegistry</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registerListenerContainer</span><span style="color:#f92672">(</span>descriptor<span style="color:#f92672">.</span><span style="color:#a6e22e">endpoint</span><span style="color:#f92672">,</span> resolveContainerFactory<span style="color:#f92672">(</span>descriptor<span style="color:#f92672">)</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">endpointDescriptors</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>descriptor<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸»è¦é€»è¾‘åœ¨åŒæ­¥ä»£ç å—ä¸­ï¼Œ<code>this.startImmediately</code>çš„å€¼é»˜è®¤ä¸ºfalseï¼Œä¹‹åä¼šæ”¹å˜ï¼Œåæ–‡ä¼šè®²åˆ°ã€‚æ‰€ä»¥æ­¤æ—¶å®ƒåªæ˜¯æš‚æ—¶æŠŠendpointå†åŒ…è£…ä¸€æ¬¡æ”¾å…¥ä¸€ä¸ªåˆ—è¡¨ä¸­ï¼Œ<code>KafkaListenerEndpointDescriptor</code>è¿™ä¸ªç±»å®Œå…¨å°±æ˜¯ä¸ªåªæœ‰ä¸¤ä¸ªå±æ€§çš„ç»“æ„ä½“ï¼Œæ²¡æœ‰å•¥ç‰¹æ®Šçš„æ–¹æ³•ã€‚å¦‚æœæ˜¯Spring Kafkaå®Œæˆäº†æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹ä¹‹åï¼Œå†æœ‰ä¸šåŠ¡æ¥è°ƒç”¨è¿™ä¸ªæ³¨å†Œæ–¹æ³•æ—¶ï¼Œå°±ä¼šç›´æ¥æ³¨å†Œåˆ°endpointRegistryä¸­ï¼Œå¹¶ç«‹å³å¯åŠ¨ã€‚</p>
<p>ï¼ˆ2ï¼‰æ‰¾åˆ°ç±»çº§åˆ«çš„æ¶ˆè´¹è€…åï¼Œ<code>processMultiMethodListeners</code>å°†è¿™äº›æ–¹æ³•åŒ…è£…åˆ°<code>MultiMethodKafkaListenerEndpoint</code>ç±»å®ä¾‹åŒ–çš„endpointä¸­ï¼Œä¹‹åçš„å¤„ç†æ–¹å¼å°±å’Œï¼ˆ1ï¼‰ä¸€æ¨¡ä¸€æ ·äº†ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒKafkaæ¶ˆè´¹è€…çš„åˆå§‹åŒ–ï¼ˆåå¤„ç†ï¼‰åŸºæœ¬å®Œæˆã€‚æ¥ä¸‹æ¥ï¼ŒSpringå¯¹<code>KafkaListenerAnnotationBeanPostProcessor</code>æä¾›çš„æœ€åä¸€ä¸ªé’©å­å°†å‘æŒ¥ä½œç”¨ï¼š<code>afterSingletonsInstantiated()</code>ã€‚</p>
<p>ç»§ç»­çœ‹çœ‹å®ƒéƒ½å¹²äº†äº›å•¥ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">afterSingletonsInstantiated</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â <span style="color:#75715e">// è®¾ç½®ä¸€äº›ä¸œè¥¿
</span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>

    <span style="color:#75715e">// ä¸ºæŸä¸ªå±æ€§è®¾ç½®EndpointRegistryï¼Œçœ¼ç†Ÿå§
</span><span style="color:#75715e"></span>Â Â Â Â <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registrar</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getEndpointRegistry</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â Â Â Â Â <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">endpointRegistry</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â Â Â Â Â Â Â Â Â Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;BeanFactory must be set to find endpoint registry by bean name&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">endpointRegistry</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>KafkaListenerConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">KAFKA_LISTENER_ENDPOINT_REGISTRY_BEAN_NAME</span><span style="color:#f92672">,</span>KafkaListenerEndpointRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

Â Â Â Â Â Â Â Â <span style="color:#75715e">// å®é™…ä¸Šè¿™ä¸ªendpointRegistryçš„Beanå°±æ˜¯åœ¨è‡ªåŠ¨é…ç½®ä¸­å£°æ˜çš„é‚£ä¸ª
</span><span style="color:#75715e"></span>Â Â Â Â Â Â Â Â <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registrar</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setEndpointRegistry</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">endpointRegistry</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
Â Â Â Â <span style="color:#f92672">}</span>

Â Â Â Â <span style="color:#75715e">// Actually register all listeners
</span><span style="color:#75715e"></span>Â Â Â Â <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registrar</span><span style="color:#f92672">.</span><span style="color:#a6e22e">afterPropertiesSet</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>è¿™ä¸ªé’©å­ä¸º<code>registrar</code>è¿™ä¸ªå¸®åŠ©ç±»çš„å®ä¾‹è®¾ç½®äº†ä¸€äº›å¿…è¦çš„å±æ€§å€¼ï¼ŒåŒæ—¶å°†<code>endpointRegistry</code>ä¹Ÿæ³¨å…¥äº†è¿›å»ï¼Œæœ€åå†è°ƒç”¨ä¸€ä¸ªå½“æ‰€æœ‰å±æ€§éƒ½å‡†å¤‡å¥½åçš„æ–¹æ³•<code>afterPropertiesSet()</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">afterPropertiesSet</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â registerAllEndpoints<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerAllEndpoints</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">endpointDescriptors</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>KafkaListenerEndpointDescriptor descriptor <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">endpointDescriptors</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">endpointRegistry</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registerListenerContainer</span><span style="color:#f92672">(</span> descriptor<span style="color:#f92672">.</span><span style="color:#a6e22e">endpoint</span><span style="color:#f92672">,</span> resolveContainerFactory<span style="color:#f92672">(</span>descriptor<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
Â Â Â Â Â Â Â Â <span style="color:#f92672">}</span>
Â Â Â Â <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">startImmediately</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>  <span style="color:#75715e">// trigger immediate startup
</span><span style="color:#75715e"></span>Â Â Â Â <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ç¬¬äºŒä¸ªæ–¹æ³•æ˜¯ä¸æ˜¯æœ‰ç‚¹çœ¼ç†Ÿï¼Œendpointæ³¨å†Œçš„æ—¶å€™ä¹Ÿæœ‰ç±»ä¼¼çš„è¿‡ç¨‹ï¼Œåªæ˜¯ç°åœ¨è¿™ä¸ªæ–¹æ³•æŠŠæ‰€æœ‰çš„descriptorå…¨éƒ¨å–äº†å‡ºæ¥å¹¶ä¸”ç«‹å³æ³¨å†Œåˆ°äº†<code>endpointRegistry</code>ä¸­ï¼Œæœ€åå°†<code>startImmediately</code>å±æ€§è®¾ç½®ä¸ºäº†<code>true</code>ã€‚</p>
<p>ç°åœ¨BeanPostProcessorçš„æ•´ä¸ªè¿‡ç¨‹éƒ½ä¸²èµ·æ¥äº†ï¼Œå¹¶ä¸”æ‰“é€šäº†ä¸€ä¸ªé€šå¾€<code>endpointRegistry</code>çš„æ¡¥æ¢ï¼Œé€šè¿‡è¿™ä¸ªæ¡¥æ¢ï¼Œ<code>KafkaListenerAnnotationBeanPostProcessor</code>å°†åŒ…è£…å¥½çš„endpointsçš„ç®¡ç†æƒç§»äº¤ç»™äº†<code>KafkaListenerEndpointRegistry</code>ï¼Œåˆ°æ­¤Spring Kafkaå¹¶æ²¡æœ‰å°†ä¸šåŠ¡é€»è¾‘å’ŒKafkaæ¶ˆè´¹è€…çœŸæ­£å…³è”èµ·æ¥ï¼Œè€Œä»…ä»…æ˜¯å¯¹ä¸šåŠ¡é€»è¾‘è¿›è¡Œäº†ä¸€ä¸ªåŒ…è£…ã€‚</p>
<h3 id="42-åˆå§‹åŒ–">4.2 åˆå§‹åŒ–</h3>
<p>å…ˆçœ‹çœ‹â€é‚£åº§æ¡¥æ¢â€œåˆ°åº•å¹²äº†å•¥ï¼š<code>KafkaListenerEndpointRegistry.registerListenerContainer()</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerListenerContainer</span><span style="color:#f92672">(</span>KafkaListenerEndpoint endpoint<span style="color:#f92672">,</span> KafkaListenerContainerFactory<span style="color:#f92672">&lt;</span><span style="color:#f92672">?</span><span style="color:#f92672">&gt;</span> factory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    registerListenerContainer<span style="color:#f92672">(</span>endpoint<span style="color:#f92672">,</span> factory<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerListenerContainer</span><span style="color:#f92672">(</span>KafkaListenerEndpoint endpoint<span style="color:#f92672">,</span> KafkaListenerContainerFactory<span style="color:#f92672">&lt;</span><span style="color:#f92672">?</span><span style="color:#f92672">&gt;</span> factory<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> startImmediately<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å‚æ•°æ ¡éªŒ
</span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>

    <span style="color:#75715e">// ä¸²ä¸€ä¸‹
</span><span style="color:#75715e"></span>Â Â Â Â <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">listenerContainers</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">(</span><span style="color:#f92672">!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">listenerContainers</span><span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>id<span style="color:#f92672">)</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Another endpoint is already registered with id &#39;&#34;</span> <span style="color:#f92672">+</span> id <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">//ï¼ˆ1ï¼‰åŒ…è£…ä¹‹æ—…è¿˜æ²¡æœ‰ç»“æŸ...
</span><span style="color:#75715e"></span>    Â Â Â Â MessageListenerContainer container <span style="color:#f92672">=</span> createListenerContainer<span style="color:#f92672">(</span>endpoint<span style="color:#f92672">,</span> factory<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    Â Â Â Â <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">listenerContainers</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> container<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

Â Â Â Â Â Â Â Â <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>startImmediately<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
Â Â Â Â Â Â Â Â Â Â Â Â startIfNecessary<span style="color:#f92672">(</span>container<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    Â Â Â Â <span style="color:#f92672">}</span>
Â Â Â Â <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å‚æ•°<code>startImmediately</code>ä¸º<code>false</code>ï¼Œè¿™è¡¨æ˜ï¼Œæ•´ä¸ªâ€ç³»ç»Ÿâ€œä»ç„¶åœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ã€‚ï¼ˆ1ï¼‰é˜¶æ®µå°†endpointå†æ¬¡åŒ…è£…æˆäº†ä¸€ä¸ª<code>MessageListenerContainer</code>ï¼Œè¿™ç©æ„æ˜¯ä¸ªæ¥å£ï¼Œæ‰€ä»¥å¾—å…·ä½“è¿›<code>createListenerContainer()</code>æ–¹æ³•çœ‹çœ‹å…¶å®ç°ç±»ã€‚åœ¨å¼€å§‹äº†è§£<code>MessageListenerConatiner</code>çš„å°è£…è¿‡ç¨‹å‰ï¼Œæœ‰ä¸€ä¸ªå‚æ•°çš„æ¥å†éœ€è¦æ ‡æ˜ä¸€ä¸‹ï¼šï¼ˆ1ï¼‰ä¸­çš„<code>factory</code>å‚æ•°ã€‚å®é™…ä¸Šå‘ä¸Šå›æº¯ï¼Œè¯¥factoryåœ¨BeanPostProcessorä¸­è¢«å¼•å…¥ï¼Œä¾æ®ä¸º<code>KafkaListener.containerFactory()</code>å±æ€§ï¼Œè¯¥å±æ€§å¯ä»¥å®šä¹‰å·¥å‚ç±»çš„åå­—ï¼Œé»˜è®¤ä¸ºåœ¨<code>KafkaAnnotationDrivenConfiguration</code>ä¸­å®šä¹‰çš„ä¸€ä¸ªå¹¶è¡Œæ¶ˆè´¹è€…å·¥å‚ï¼š<code>ConcurrentKafkaListenerContainerFactory</code>ï¼Œæ­¤å¤„ä¸å±•å¼€ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹çœ‹æºç ï¼Œè¿™ä¸ªç±»åŒ…å«äº†ä»Springé…ç½®æ–‡ä»¶ä¸­è·å–çš„å¯¹Kafkaæ¶ˆè´¹è€…çš„å…·ä½“é…ç½®ï¼Œæ¯”å¦‚Message Converterã€Error Handlerã€Transaction Managerç­‰ç­‰ï¼Œè¿™ä¸ªç±»å°†å¸®åŠ©ï¼ˆ1ï¼‰æ¥åŒ…è£…endpointã€‚</p>
<p>å·¥å‚ç±»å°†æŠŠæ¶ˆè´¹è€…çš„å…¬å…±é…ç½®å‚æ•°ç»“åˆæ³¨è§£çš„å‚æ•°ï¼Œä¸€å¹¶åˆå§‹åŒ–åˆ°<code>MessageListenerContainer</code>ä¸­ï¼Œè¿™æ ·ï¼Œå®ƒæ‰æ‹¥æœ‰äº†å®Œæ•´çš„å’Œkafkaæ¶ˆè´¹è€…ç›¸å…³çš„é…ç½®ã€‚</p>
<p>è‡³æ­¤ï¼Œæ‰€æœ‰Spring Kafkaçš„ç›¸å…³é…ç½®å‚æ•°çš„åˆå§‹åŒ–å®Œæˆï¼Œæ¥ä¸‹æ¥ï¼Œå°±è¦å°†è¿™äº›æ–¹æ³•å’Œé…ç½®ï¼Œå’ŒåŸç”ŸKafkaConsumerç»“åˆèµ·æ¥ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨åŸç”ŸKafkaå®¢æˆ·ç«¯æ¥è¿›è¡Œæ¶ˆè´¹æ“ä½œäº†ã€‚</p>
<h3 id="43-è¿è¡Œæ¶ˆè´¹è€…">4.3 è¿è¡Œæ¶ˆè´¹è€…</h3>
<p>åœ¨äº†è§£Spring Kafkaå¦‚ä½•åˆ›å»ºåŸç”Ÿçš„KafkaConsumerä¹‹å‰ï¼Œå…ˆçœ‹çœ‹<code>KafkaAutoConfiguration</code>å®šä¹‰çš„ä¸€ä¸ªå’Œæ¶ˆè´¹è€…ç›¸å…³çš„Beanã€‚</p>
<ul>
<li>kafkaConsumerFactory - <code>DefaultKafkaConsumerFactory</code></li>
</ul>
<p>åˆæ˜¯ä¸€ä¸ªå·¥å‚ï¼ŒçœŸæ˜¯æ— å¤„ä¸åœ¨çš„å·¥å‚å‘€ã€‚</p>
<p>å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªBeanæ˜¯ç”¨æ¥ç”Ÿäº§æ¶ˆè´¹è€…çš„ï¼ˆKafkaConsumerï¼Œè¿™è´§æ˜¯åŸç”Ÿçš„kafkaæ¶ˆè´¹è€…ï¼Œå’ŒSpring Kafkaæ²¡å•¥å…³ç³»ï¼‰ï¼Œè¿™ä¸ªBeanåœ¨åŒ…è£…ContainerFactoryç”Ÿäº§Containerçš„æ—¶å€™è¢«åˆå§‹åŒ–è¿›å»äº†ï¼Œæ‰€ä»¥ï¼Œæ¯ä¸€ä¸ªContaineréƒ½æœ‰èƒ½åŠ›ç”Ÿäº§æ¶ˆè´¹è€…ã€‚ä¹‹æ‰€ä»¥è®©Containeræœ‰èƒ½åŠ›ç”Ÿäº§æ¶ˆè´¹è€…ï¼Œå’Œå…¶æ³¨è§£æä¾›çš„<code>concurrency</code>èƒ½åŠ›ç›¸å…³ï¼Œä»¥åŠå¤štopicï¼Œå¤špartitionsæ¶ˆè´¹ç›¸å…³ã€‚</p>
<p>å§‘ä¸”å¯ä»¥ç†è§£ä¸ºä¸€ä¸ª<code>@KafkaListener</code>å°±ä»£è¡¨äº†ä¸€ä¸ªContainerã€‚</p>
<p>é‚£å¦‚ä½•åˆå§‹åŒ–æ¶ˆè´¹è€…ï¼Œä»¥åŠå¦‚ä½•å¯åŠ¨æ¶ˆè´¹çš„å‘¢ï¼Ÿ</p>
<p><code>KafkaListenerEndpointRegistry</code> å®ç°äº† <code>SmartLifecycle</code> æ¥å£ï¼Œæ‰€ä»¥ï¼Œå¯åŠ¨æ–¹æ³•äº¤ç”±Springæ¥è´Ÿè´£è°ƒç”¨ï¼Œå³ <code>SmartLifecycle.start()</code> å¼€å§‹ï¼Œç»è¿‡å±‚å±‚è°ƒç”¨ï¼Œå®é™…ä¸Šæœ€å…³é”®çš„å¯åŠ¨æ–¹æ³•ä¸º<code>ConcurrentMessageListenerContainer.doStart()</code>ã€‚æ¥ï¼Œå’±ç…ä¸€ç…</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doStart</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å‚æ•°æ ¡éªŒå’Œè®¾ç½®
</span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>

    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">concurrency</span><span style="color:#f92672">;</span> i<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Â Â Â Â <span style="color:#75715e">//ï¼ˆ1ï¼‰æ ¹æ®concurrencyæ•°é‡ï¼Œæ¯ä¸€æ¬¡å¾ªç¯åˆå•ç‹¬åˆå§‹åŒ–ä¸€ä¸ªcontainer
</span><span style="color:#75715e"></span>        KafkaMessageListenerContainer<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> container<span style="color:#f92672">;</span>
        <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
        container<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">containers</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>container<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ï¼ˆ1ï¼‰æ ¹æ®æ³¨è§£ä¸­concurrencyé…ç½®çš„æ•°é‡ï¼Œåˆå§‹åŒ–å¯¹åº”æ•°é‡çš„å•Containerï¼Œè¿™ä¸ªå•Containerå’Œå…¶æœ¬èº«æ˜¯ä¸ä¸€æ ·çš„å“¦ï¼Œå¦‚æœå°†<code>ConcurrentMessageListenerContainer</code>å’Œ<code>@KafkaListener</code>ä¸€ä¸€å¯¹åº”ï¼Œé‚£<code>KafkaMessageListenerContainer</code> å°±å¯ä»¥ç†è§£ä¸ºå’Œï¼ˆtopicï¼Œpartitionï¼‰ä¸€ä¸€å¯¹åº”äº†ï¼Œæ¯•ç«Ÿï¼Œè™½ç„¶æ³¨è§£ä¸­å®šä¹‰äº†å¤šä¸ªtopicsæˆ–è€…å¤šä¸ªpartitionsï¼Œä½†æ˜¯å®é™…ä¸Šæ¶ˆè´¹çš„æ—¶å€™ï¼Œä»–ä»¬è‚¯å®šéƒ½æ˜¯åˆ†å¼€æ‹‰å–æ¶ˆæ¯æ¶ˆè´¹çš„ã€‚æœ€åä¼šè°ƒç”¨<code>container.start()</code>ã€‚ç»§ç»­çœ‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doStart</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// æ ¡éªŒå‚æ•°ä¹‹ç±»çš„
</span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>

    <span style="color:#75715e">// Runnable
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">listenerConsumer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ListenerConsumer<span style="color:#f92672">(</span>listener<span style="color:#f92672">,</span> listenerType<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

    <span style="color:#75715e">// å¦èµ·çº¿ç¨‹æ‰§è¡Œäº†
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">listenerConsumerFuture</span> <span style="color:#f92672">=</span> containerProperties
            <span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerTaskExecutor</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">submitListenable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">listenerConsumer</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å¾ˆæ˜æ˜¾ï¼Œé‡ç‚¹åœ¨<code>ListenerConsumer</code>ç±»ä¸Šï¼Œè¯¥ç±»å®ç°äº†ä¸¤ä¸ªæ¥å£ï¼š</p>
<ul>
<li>
<p><code>ConsumerSeekCallback</code></p>
</li>
<li>
<p><code>SchedulingAwareRunnable</code></p>
</li>
</ul>
<p>ç¬¬ä¸€ä¸ªæ¥å£çš„ä½œç”¨åœ¨äºå¯è‡ªå®šä¹‰æ¶ˆè´¹çš„èµ·ç‚¹ï¼Œç¬¬äºŒä¸ªæ¥å£æœ‰ç‚¹æ„æ€ï¼Œå®ƒæ¯”<code>Runnable</code>å°±å¤šä¸€ä¸ª<code>isLongLived()</code>æ¥å£ï¼Œç”¨äºå‘Šè¯‰<code>WorkManager</code>ï¼Œè¿™æ˜¯ä¸ªé•¿è·‘çº¿ç¨‹ï¼Œå®ƒä¸ä¼šè‡ªå·±åœæ­¢ã€‚æ›´å…·ä½“çš„ï¼Œå¯ä»¥çœ‹ä¸€çœ‹å‚è€ƒä¸­ç¬¬ä¸‰ä¸ªé“¾æ¥ï¼Œæœ‰æ¯”è¾ƒè¯¦ç»†çš„æè¿°ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//å®šä¹‰æ¶ˆè´¹èµ·ç‚¹
</span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
    <span style="color:#75715e">// æŒç»­æ‹‰å–å’Œæ¶ˆè´¹
</span><span style="color:#75715e"></span>Â Â Â Â <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>isRunning<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
    Â Â Â Â pollAndInvoke<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
    <span style="color:#f92672">}</span>
    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pollAndInvoke</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// æäº¤offset ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°å®šä¹‰æ¶ˆè´¹èµ·ç‚¹ ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// æ£€æŸ¥æ˜¯å¦è¢«æš‚åœ ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// æ‹‰å–æ¶ˆæ¯
</span><span style="color:#75715e"></span>Â Â Â Â ConsumerRecords<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> records <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">poll</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pollTimeout</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

    <span style="color:#75715e">// æ¶ˆè´¹æ¶ˆæ¯
</span><span style="color:#75715e"></span>    invokeListener<span style="color:#f92672">(</span>records<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>æ³¨é‡Šå·²ç»æŠŠè¿‡ç¨‹æŠ½è±¡å‡ºæ¥ï¼ŒSpring Kafkaå®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨äº†åŸç”ŸKafkaå®¢æˆ·ç«¯çš„<code>KafkaConsumer.poll()</code>æ–¹æ³•æ¥è·å–kafkaæ¶ˆæ¯ï¼Œç„¶åå†å–‚ç»™ä¸šåŠ¡è¿‡ç¨‹ã€‚</p>
<h2 id="6-æ€»ç»“">6. æ€»ç»“</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">graph TD;
 A<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@KafkaListener: æ³¨è§£å‚æ•°&#34;</span><span style="color:#f92672">)</span>--&gt;B<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;MethodKafkaListenerEndpoint&#34;</span><span style="color:#f92672">)</span>;
 B--&gt;D;
 C<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ConcurrentKafkaListenerContainerFactory: é…ç½®å‚æ•°&#34;</span><span style="color:#f92672">)</span>--&gt;D<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;KafkaListenerEndpointDescriptor&#34;</span><span style="color:#f92672">)</span>;
 D-.-&gt;|æ³¨å†Œ|E<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;KafkaListenerEndpointRegistrar: è¾…åŠ©ç±»&#34;</span><span style="color:#f92672">)</span>;
 E--&gt;F<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ConcurrentMessageListenerContainer&#34;</span><span style="color:#f92672">)</span>;
 F-.-&gt;|æ³¨å†Œ|G<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;KafkaListenerEndpointRegistry&#34;</span><span style="color:#f92672">)</span>;
 G-.-&gt;|start|H<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ConcurrentMessageListenerContainer&#34;</span><span style="color:#f92672">)</span>;
 H--&gt;I<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;KafkaMessageListenerContainer1&#34;</span><span style="color:#f92672">)</span>;
 H--&gt;M<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;KafkaMessageListenerContainer...&#34;</span><span style="color:#f92672">)</span>;
 I--&gt;N<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ListenerConsumer: Runnable&#34;</span><span style="color:#f92672">)</span>;
 N--&gt;N;
 J<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Spring BeanPostProcessor&#34;</span><span style="color:#f92672">)</span>-.-&gt;|é©±åŠ¨|A
 K<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Spring InitializingBean&#34;</span><span style="color:#f92672">)</span>-.-&gt;|é©±åŠ¨|E
 L<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Spring SmartLifeCycle&#34;</span><span style="color:#f92672">)</span>-.-&gt;|é©±åŠ¨|G
</code></pre></div><p><img src="https://raw.githubusercontent.com/XIEJD/blog-images/master/2020/02/23-18-45-01-output.png" alt="output.png"></p>
<h2 id="7-æœ‰æ„Ÿ">7. æœ‰æ„Ÿ</h2>
<p>æœ‰æ—¶å€™ï¼Œå› ä¸ºä¸šåŠ¡éœ€è¦å¿«é€Ÿå®ç°ï¼Œæ²¡åŠæ³•å®Œå…¨æŒæ¡ä¸€é—¨æ¡†æ¶åå†ä¸‹æ‰‹ï¼Œè¿™å°±å¯¼è‡´äº†ä»£ç çš„ä¸å¯æ§ï¼Œæœ‰äº›æƒ…å†µä¸‹ï¼ŒCoderä¼šå¤±äº†ç¥ï¼Œè¿™æ ·å®ç°åˆ°åº•framework nativeå—ï¼Ÿå¦‚æœå¼•å…¥ä¸€ä¸ªæ¡†æ¶è€Œæ— æ³•æ¦¨å–å®ƒçš„ä»·å€¼ï¼Œé‚£å°±å¾—è€ƒè™‘å®ƒå­˜åœ¨çš„æ„ä¹‰äº†ï¼Œä¾èµ–æ•°é‡å’Œå¤æ‚åº¦è‚¯å®šæ˜¯æ­£æ¯”å…³ç³»ã€‚å¦‚ä½•èƒ½æ¦¨å–æ¡†æ¶çš„ä»·å€¼ï¼Ÿã€‚å¯¹äºæˆ‘è€Œè¨€ï¼Œä»ä¸‹è€Œä¸Šçš„æ•ˆç‡å¤ªä½ã€‚å¾€å¾€ä¹°äº†ä¸€æœ¬ã€ŠXXXå®è·µã€‹ï¼Œè¿˜æ²¡ç¿»åˆ°ä¸šåŠ¡å¼ºç›¸å…³çš„åœ°æ–¹ï¼Œå°±æ²¡æ—¶é—´äº†ï¼ŒåšæŒä¸ä¸‹å»äº†ï¼Œç„¶åå°˜å°äºä¹¦æ¡Œã€‚å¯¹äºCoderè€Œè¨€ï¼Œæœ€å¥½çš„æè¿°è¯­è¨€æ˜¯Codeï¼Œç‚¹å¼€IDEAï¼Œâ€œDownload Sourcesâ€ï¼Œçœ‹æºç çš„è¿‡ç¨‹å¯èƒ½ä¼šç—›è‹¦ï¼Œä½†æ˜¯å•¥éƒ½ä¸ä¼šçš„åæœä¼šæ›´ç—›è‹¦ã€‚ğŸ„ğŸ»â€â™‚ï¸</p>
<h2 id="8-å‚è€ƒ">8. å‚è€ƒ</h2>
<ol>
<li>
<p><a href="https://docs.spring.io/spring-kafka/docs/2.2.12.RELEASE/reference/html/#even-quicker-with-spring-boot">https://docs.spring.io/spring-kafka/docs/2.2.12.RELEASE/reference/html/#even-quicker-with-spring-boot</a></p>
</li>
<li>
<p><a href="https://juejin.im/post/5ab1bf19f265da23771947f1">https://juejin.im/post/5ab1bf19f265da23771947f1</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/8659609/thread-keeps-running-even-after-application-has-been-stopped-in-websphere">https://stackoverflow.com/questions/8659609/thread-keeps-running-even-after-application-has-been-stopped-in-websphere</a></p>
</li>
</ol>

      </div>


      <footer>
        


            <div id="vssue"></div>
    <link rel="stylesheet" href="https://unpkg.com/vssue/dist/vssue.min.css">
    <script src="https://unpkg.com/vue/dist/vue.runtime.min.js"></script>
    <script src="https://unpkg.com/vssue/dist/vssue.github.min.js"></script>
    <script>
        if (window.location.hostname != "localhost") {
            new Vue({
                el: '#vssue',
                render: h => h('Vssue', {
                    props: {
                        title: options => `${options.prefix}comments on ${document.location.pathname}`,
                        options: {
                            autoCreateIssue: true,
                            owner: 'XIEJD',
                            repo: 'xiejd.github.io',
                            clientId: 'd49c970afdb5dc4631f9',
                            clientSecret: '200eadf0eaf8388c460170701a3af5155208133d', 
                        },
                    }
                })
            })
        }
    </script>

        
        
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
      <p>æµ“äºåˆ©ç”Ÿè´ªï¼Œæµ“äºåç”Ÿå—”ï¼Œæµ“äºæƒ…ç”Ÿç—´ã€‚</p>
    
    
      
        Â© 2020
      
       Shareif 
    
    
       Â· 
      Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
